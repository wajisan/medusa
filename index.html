<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="utf-8">
	<title>Medusa</title>
	<link rel="stylesheet" href="/css/style.css" />
	<link rel="stylesheet" href="/css/bootstrap.min.css" />
	<link href="https://fonts.googleapis.com/css?family=Alegreya+Sans:300" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
</head>
<body>
	<div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom box-shadow">
            <h5 class="my-0 mr-md-auto font-weight-normal">Medusa</h5>
    </div>
	<div class="container">
		<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
            <h1 class="display-4">Medusa</h1>
            <p class="lead">Permet de garder un oeil sur vos urls favorites.</p>

            <input id='inputNext' class="form-control" type='text' placeholder="InsÃ©rez votre url ici" /><br/>
            <button type=" button" class="btn btn-lg btn-outline-secondary" onclick="pushIt()">Ajouter</button>
            
        </div>

		<div class="infos">
			<div class="info2">Fonctionne</div>
			<div class="info3">Redirection</div>
			<div class="info4">Erreur Client</div>
			<div class="info5">Erreur Serveur</div>
		</div>
		<div id="urlContainer" class="row"></div>
	</div>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
		
		var links =
		{ 
		  queue: []
		};

		var socket = io.connect();
		
		$("form#chat").submit(function(e) {
		   	e.preventDefault();
			socket.emit("send message", $(this).find("#msg_text").val(), function() {
		    	$("form#chat #msg_text").val("");
		  	});
		});

		function checkLocalStorage(){
			var restoredLinks = JSON.parse(localStorage.getItem('links'));
			if (restoredLinks == undefined || restoredLinks.queue == undefined)
				localStorage.setItem('links', JSON.stringify(links));
			outputIt();
		}

		checkLocalStorage();
		socket.on("update messages", function(data){
			if (data.code == "500" && data.msg.errno != undefined)
				data.msg = data.msg.errno;
			var codeClass = 0;
			if (parseInt(data.code, 10) <= 299) {
				codeClass = 'code2';
			}
			else if (parseInt(data.code, 10) <= 399) {
				codeClass = 'code3';
			}
			else if (parseInt(data.code, 10) <= 499) {
				codeClass = 'code4';
			}
			else {
				codeClass = 'code5';
			}

			var final_message = '<div class="'+codeClass+'"><span class="deleteButton card-header"><button type=" button" onclick="removeLink(\''+data.url+'\')"class="btn btn-lg btn-light">Effacer</button></span><span class="httpcode">'+data.code+'</span><span class="urlclass">'+data.url+'</span></div>';

			if (data.url !== undefined) {
				if ($('#url'+data.id).find('.loading').length !== 0){
		   			$('#url'+data.id).html(final_message);//append
		   		}
		   		else
		   			$('#url'+data.id).append(final_message);
			}
		});

		function outputIt() {
		  	var restoredLinks = JSON.parse(localStorage.getItem('links'));
		  	var outputs = "";
		  	//document.getElementById("urlContainer").innerHTML = '';
		  	for(var i = 0; i < restoredLinks.queue.length; i++)
		  	{
		  		if (!$('#url'+restoredLinks.queue[i].id).length) {
			  		$('#urlContainer').append('<div class="urlItem col-lg-3 col-md-4 col-sm-6 col-xs-12" id="url'+restoredLinks.queue[i].id+ '"><span class="deleteButton" onclick="removeLink(\''+restoredLinks.queue[i].name+'\')">X</span><div class="loading"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>');
			  		socket.emit("send message", {url:restoredLinks.queue[i].name, id:restoredLinks.queue[i].id}, function() {
			  		});
		  		}
		  	}
		}

		function removeLink(nameUrl) {
			var restoredLinks  = JSON.parse(localStorage.getItem('links'));
			var found = restoredLinks.queue.find(function(element) {
			  if (element.name == nameUrl)
			  	return element;
			});
			//console.log(found);
			var index = restoredLinks.queue.indexOf(found);
			if (index > -1) {
			  	restoredLinks.queue.splice(index, 1);
			  	$('#url'+found.id).remove();
				localStorage.setItem('links', JSON.stringify(restoredLinks));
			}
			//var removedLink = restoredLinks.queue.shift();
			//$('#url'+removedLink.id).remove();
			//localStorage.setItem('links', JSON.stringify(restoredLinks));
			//outputIt();
		}

		function popIt() {
			var restoredLinks  = JSON.parse(localStorage.getItem('links'));  
			var removedLink = restoredLinks.queue.shift();
			$('#url'+removedLink.id).remove();
			localStorage.setItem('links', JSON.stringify(restoredLinks));
			//outputIt();
		}

		function urlExists(arr, url) {
		  return arr.some(function(el) {
		    return el.name === url;
		  }); 
		}

		function pushIt() {
		  	if ($('#inputNext').val() != ''){
			  	var restoredLinks = JSON.parse(localStorage.getItem('links'));
			  

			  	if (!urlExists(restoredLinks.queue, $('#inputNext').val())) {
				  	restoredLinks.queue.push({
				    	name: $('#inputNext').val(),
				    	id: '_' + Math.random().toString(36).substr(2, 9)
				  	});
				  	localStorage.setItem('links', JSON.stringify(restoredLinks));
				  	$('#inputNext').val('');
				  	outputIt();
			  	}
			  	else
			  		alert('url currently tested');
		  	}
		  	else
		  		alert('invalid format');
		}
	</script>

</body>
</html>